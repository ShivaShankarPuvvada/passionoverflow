{% extends 'base.html' %}
{% load static %}
{% block title %}Tickets | Kanban board{% endblock %}
{% block stylesheets %}
    <style>
        * {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
            }
            
            *::-webkit-scrollbar {
            display: none;
            }

            #project-select,
            #segment-select {
                width: 200px;
            }

            
            .board {
            width: 100%;
            height: 70vh;
            overflow: scroll;
            background-color: wheat;
            background-position: center;
            background-size: cover;
            border-radius: 5px;
            }

            /* ---- BOARD ---- */
            .lanes {
            display: flex;
            align-items: flex-start;
            justify-content: start;
            gap: 16px;
            
            padding: 24px 32px;
            
            overflow: scroll;
            height: 100%;
            }
            
            .heading {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 8px;
            }
            
            .swim-lane {
            display: flex;
            flex-direction: column;
            gap: 12px;
            
            background: #f4f4f4;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.25);
            
            padding: 12px;
            border-radius: 4px;
            width: 225px;
            min-height: 120px;
            
            flex-shrink: 0;
            }
            

            .create-stage-button {
                display: flex;
                flex-direction: column;
                gap: 12px;
                border-radius: 4px;
                width: 225px;
                flex-shrink: 0;
            }

            .task {
                background: white;
                color: black;
                box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.15);
                padding: 8px; /* Adjust padding if needed */
                border-radius: 4px;
                font-size: 14px; /* Adjust to the minimum readable size */
                cursor: move;
                max-width: 100%;
                overflow-wrap: break-word; /* Break long words */
                word-wrap: break-word; /* For older browsers */
                white-space: normal; /* Ensure text wraps properly */
                line-height: 1.4; /* Ensure enough spacing for readability */
            }
            
            @media (max-width: 600px) {
                .task {
                    font-size: 10px; /* Smaller size for smaller screens if needed */
                }
            }
            
            .is-dragging {
            scale: 1.05;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.25);
            background: rgb(50, 50, 50);
            color: white;
            }
    </style>
{% endblock stylesheets %}
{% block content %}
<div class="container mt-4">
    <a href="{% url 'tickets:create_ticket' %}" class="btn btn-custom">Create Ticket</a>
    <h2>Kanban board</h2>

    <!-- Add Project and Segment Select Boxes -->
    <div class="row g-3 mb-3 align-items-center">
        <div class="col-auto">
            <label for="project-select" class="col-form-label">Project:</label>
        </div>
        <div class="col-auto">
            <select id="project-select" class="form-control">
                <option value="">Select Project</option>
                {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <label for="segment-select" class="col-form-label">Segment:</label>
        </div>
        <div class="col-auto">
            <select id="segment-select" class="form-control">
                <option value="">Select Segment</option>
            </select>
        </div>
    </div>

    <div class="board">
        <div class="lanes">
        </div>
    </div>
</div>
{% endblock %}

{% block endscript %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script>
        $(document).ready(function() {
            const baseTicketPostsUrl = "{% url 'posts:ticket_posts' 0 %}"; // URL pattern with a placeholder
            const $projectSelect = $('#project-select');
            const $segmentSelect = $('#segment-select');
            const $lanes = $('.lanes');
        
            function showCreateStageButton() {
                // Check if the button already exists
                if ($('#create-stage-button').length === 0) {
                    $lanes.append(`
                        <div id="create-stage-button" class="create-stage-button">
                            <button class="btn btn-custom">
                                <i class="bi bi-plus"></i> Create Stage
                            </button>
                        </div>
                    `);
                } else {
                    // Move it to the end if it already exists
                    $lanes.append($('#create-stage-button'));
                }
            }
        
            function hideCreateStageButton() {
                $('#create-stage-button').remove();
            }
        
            // Fetch segments when project is selected
            $projectSelect.on('change', function() {
                const projectId = $(this).val();
                if (projectId) {
                    $.ajax({
                        url: "{% url 'tickets:fetch_segments' %}",
                        data: { project_id: projectId },
                        success: function(response) {
                            $segmentSelect.empty();
                            $segmentSelect.append('<option value="">Select Segment</option>');
                            response.segments.forEach(segment => {
                                $segmentSelect.append(`<option value="${segment.id}">${segment.title}</option>`);
                            });
                            $segmentSelect.trigger('change'); // Trigger change to load tickets and stages
                            showCreateStageButton();
                        }
                    });
                } else {
                    $segmentSelect.empty().append('<option value="">Select Segment</option>');
                    $lanes.empty(); // Clear lanes if no project is selected
                    hideCreateStageButton();
                }
            });
        
            // Fetch tickets and stages when segment is selected
            $segmentSelect.on('change', function() {
                const segmentId = $(this).val();
                const projectId = $projectSelect.val();
                if (segmentId || projectId) {
                    $.ajax({
                        url: "{% url 'tickets:fetch_tickets_and_stages' %}",
                        data: { segment_id: segmentId, project_id: projectId },
                        success: function(response) {
                            // Only update lanes and preserve the Create Stage button
                            $lanes.children('.swim-lane').not('#create-stage-button').remove();
                            response.stages.forEach(stage => {
                                const $lane = $('<div>', { class: 'swim-lane', 'data-stage-id': stage.id }).append(`<h3 class="heading">${stage.title}</h3>`);
                                response.tickets[stage.id].forEach(ticket => {
                                    const ticketUrl = baseTicketPostsUrl.replace('0', `${ticket.id}`);
                                    const $task = $(`
                                        <p class="task" draggable="true" id="${ticket.id}">
                                            Ticket: <a href="${ticketUrl}" class="ticket-link">#${ticket.company_ticket_counter}</a><br>${ticket.title}
                                            <br>Ticket type: ${ticket.ticket_type_display}
                                        </p>
                                    `);
                                    $lane.append($task);
                                });
                                $lanes.append($lane);
                            });
                            showCreateStageButton(); // Ensure button is at the end
                            initializeDragAndDrop(); // Reinitialize drag-and-drop after content update
                        }
                    });
                } else {
                    hideCreateStageButton();
                }
            });
        
            // Function to initialize drag-and-drop functionality
            function initializeDragAndDrop() {
                const draggables = document.querySelectorAll(".task");
                const droppables = document.querySelectorAll(".swim-lane");
        
                draggables.forEach((task) => {
                    task.addEventListener("dragstart", () => {
                        task.classList.add("is-dragging");
                    });
                    task.addEventListener("dragend", () => {
                        task.classList.remove("is-dragging");
                    });
                });
        
                droppables.forEach((zone) => {
                    zone.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        const bottomTask = insertAboveTask(zone, e.clientY);
                        const curTask = document.querySelector(".is-dragging");
                        if (!bottomTask) {
                            zone.appendChild(curTask);
                        } else {
                            zone.insertBefore(curTask, bottomTask);
                        }
                    });
                });
        
                const insertAboveTask = (zone, mouseY) => {
                    const els = zone.querySelectorAll(".task:not(.is-dragging)");
                    let closestTask = null;
                    let closestOffset = Number.NEGATIVE_INFINITY;
                    els.forEach((task) => {
                        const { top } = task.getBoundingClientRect();
                        const offset = mouseY - top;
                        if (offset < 0 && offset > closestOffset) {
                            closestOffset = offset;
                            closestTask = task;
                        }
                    });
                    return closestTask;
                };
            }
        
            // Initialize drag-and-drop on page load
            initializeDragAndDrop();
        
            // Function to initialize Sortable.js for both stages and tasks
            function initializeSortable() {
                // Make stages (columns) sortable
                new Sortable($lanes[0], {
                    animation: 150,
                    handle: '.heading', // Only allow dragging by the heading
                    onEnd: function (evt) {
                        // Update stage order in backend if necessary
                        console.log('Stage moved from', evt.oldIndex, 'to', evt.newIndex);
                    }
                });
        
                // Make tasks sortable within and between stages
                document.querySelectorAll('.swim-lane').forEach((lane) => {
                    new Sortable(lane, {
                        group: 'tasks',
                        animation: 150,
                        onEnd: function (evt) {
                            // Update task order and stage in backend if necessary
                            console.log('Task moved from', evt.oldIndex, 'to', evt.newIndex, 'within list', evt.from, 'to list', evt.to);
                        }
                    });
                });
            }
        
            // Initialize Sortable.js on page load
            initializeSortable();
        });
        
        
    </script>
{% endblock %}
