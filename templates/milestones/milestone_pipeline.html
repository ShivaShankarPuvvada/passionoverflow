{% extends 'base.html' %}
{% load static %}

{% block title %}Milestone Pipeline{% endblock %}

{% block stylesheets %}
<style>
  .pipeline-container {
    margin: 20px auto; /* Center container horizontally */
    width: 100%;
    height: 600px; /* Adjust height as needed */
    overflow-x: auto; /* Allow horizontal scrolling */
    position: relative; /* Needed for tooltip positioning */
    box-sizing: border-box; /* Include padding and border in width and height */
  }
  .link {
    stroke-width: 18px;
    stroke-linecap: round;
    stroke-linejoin: round;
    fill: none;
  }
  .link-end {
    fill: none;
    stroke-width: 12px; /* Increase outer circle ring width */
  }
  .link-end-dot {
    fill: #fff; /* Inner circle color */
  }
  .tooltip {
    position: absolute;
    text-align: center;
    padding: 6px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
  }
</style>
{% endblock stylesheets %}

{% block content %}
<header class="header">
    <h1>
        <i class="bi bi-circle"></i> Milestone Pipeline
    </h1>
</header>

<div id="pipeline" class="pipeline-container"></div>
{% endblock %}

{% block endscript %}
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.querySelector('.pipeline-container');
    const containerWidth = container.clientWidth;
    const svgHeight = 600; // SVG height

    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute('width', containerWidth);
    svg.setAttribute('height', svgHeight);
    container.appendChild(svg);

    const data = Array.from({ length: 50 }, (_, i) => ({
      text: `Milestone ${i + 1}`,
      completed: i % 2 === 0,
      x: 0,
      y: 0
    }));

    const spacing = 80;
    const uTurnThreshold = containerWidth - spacing;

    let x = spacing; // Start x at spacing to avoid edge
    let y = spacing;
    let direction = 1; // 1 for right, -1 for left
    const colors = d3.schemeCategory10; // Use D3 color scheme

    data.forEach((d, i) => {
      if (x > uTurnThreshold && direction === 1) {
        direction = -1;
        y += spacing; // Move down to the next row
        x -= spacing; // Adjust x to start below the last point
      } else if (x < spacing && direction === -1) {
        direction = 1;
        y += spacing; // Move down to the next row
        x += spacing; // Adjust x to start below the last point
      }

      d.x = x;
      d.y = y;
      x += spacing * direction;
    });

    // Create the paths manually
    data.slice(1).forEach((d, i) => {
      const previousPoint = data[i];
      let pathData;

      // Check if moving to the next line
      if (previousPoint.y !== d.y) {
        // Create a quadratic Bezier curve for U-turns
        const controlPointX = (previousPoint.x + d.x) / 2;
        const controlPointY = previousPoint.y;
        pathData = `M ${previousPoint.x},${previousPoint.y} Q ${controlPointX},${controlPointY - 40} ${d.x},${d.y}`;
      } else {
        // Create a straight line for other segments
        pathData = `M ${previousPoint.x},${previousPoint.y} L ${d.x},${d.y}`;
      }

      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute('class', 'link');
      path.setAttribute('d', pathData);
      path.setAttribute('stroke', colors[i % colors.length]);
      path.setAttribute('stroke-width', '3');
      svg.appendChild(path);
    });

    // Add circular endpoints with outer color and inner white dot
    data.slice(1).forEach((d, i) => {
      const circleOuter = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circleOuter.setAttribute('class', 'link-end');
      circleOuter.setAttribute('cx', d.x);
      circleOuter.setAttribute('cy', d.y);
      circleOuter.setAttribute('r', 14);
      circleOuter.setAttribute('stroke', colors[i % colors.length]);
      svg.appendChild(circleOuter);

      const circleInner = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circleInner.setAttribute('class', 'link-end-dot');
      circleInner.setAttribute('cx', d.x);
      circleInner.setAttribute('cy', d.y);
      circleInner.setAttribute('r', 10);
      svg.appendChild(circleInner);
    });

    // Tooltip
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.style.opacity = 0;
    document.body.appendChild(tooltip);

    svg.querySelectorAll('.link').forEach((link, index) => {
      link.addEventListener('mouseover', function (event) {
        tooltip.style.transition = 'opacity 0.2s';
        tooltip.style.opacity = 0.9;
        tooltip.innerHTML = data[index + 1].text;
        tooltip.style.left = `${event.pageX}px`;
        tooltip.style.top = `${event.pageY - 28}px`;
      });

      link.addEventListener('mouseout', function () {
        tooltip.style.transition = 'opacity 0.5s';
        tooltip.style.opacity = 0;
      });
    });
  });
</script>
{% endblock %}
