{% extends 'base.html' %}
{% load static %}

{% block title %}Milestone Pipeline{% endblock %}
{% block stylesheets %}
<style>
  .pipeline-container {
    margin: 20px 0;
    width: 100%;
    height: auto;
    overflow-x: auto;
  }
  .link {
    stroke-width: 18px;
    stroke-linecap: round;
    stroke-linejoin: round;
  }
  .link-end {
    fill: none;
    stroke-width: 12px; /* Increase outer circle ring width */
  }
  .link-end-dot {
    fill: #fff; /* Inner circle color */
  }
  .tooltip {
    position: absolute;
    text-align: center;
    padding: 6px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
  }
</style>
{% endblock stylesheets %}

{% block content %}
<header class="header">
    <h1>
        <i class="bi bi-circle"></i> Milestone Pipeline
    </h1>
</header>

<div id="pipeline" class="pipeline-container"></div>
{% endblock %}

{% block endscript %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const svg = d3.select('#pipeline')
      .append('svg')
      .attr('width', '100%')
      .attr('height', 600);

    const data = Array.from({ length: 50 }, (_, i) => ({
      text: `Milestone ${i + 1}`,
      completed: i % 2 === 0
    }));

    const margin = { top: 20, right: 30, bottom: 30, left: 40 };
    const width = 1200 - margin.left - margin.right;
    const height = 600 - margin.top - margin.bottom;

    const spacing = 80;
    const uTurnThreshold = width - spacing;

    let x = 50;
    let y = 50;
    let direction = 1; // 1 for right, -1 for left
    const colors = d3.schemeCategory10; // Use D3 color scheme

    data.forEach((d, i) => {
      if (x > uTurnThreshold && direction === 1) {
        direction = -1;
        y += 100; // Move down to the next row
      } else if (x < 50 && direction === -1) {
        direction = 1;
        y += 100; // Move down to the next row
      }

      d.x = x;
      d.y = y;
      x += spacing * direction;
    });

    // Draw the lines and set their colors
    const links = svg.selectAll('.link')
      .data(data.slice(1))
      .enter()
      .append('line')
      .attr('class', 'link')
      .attr('x1', (d, i) => data[i].x)
      .attr('y1', (d, i) => data[i].y)
      .attr('x2', d => d.x)
      .attr('y2', d => d.y)
      .style('stroke', (_, i) => colors[i % colors.length]); // Assign different colors for each link

    // Add circular endpoints with outer color and inner white dot
    svg.selectAll('.link-end')
      .data(data.slice(1))
      .enter()
      .append('circle')
      .attr('class', 'link-end')
      .attr('cx', d => d.x)
      .attr('cy', d => d.y)
      .attr('r', 14) // Increased radius for outer ring
      .style('stroke', (_, i) => colors[i % colors.length]) // Outer ring color
      .style('stroke-width', '9px') // Increased outer ring width
      .style('fill', 'none'); // No fill for the outer circle

    // Add inner white dot to the circular endpoint
    svg.selectAll('.link-end-dot')
      .data(data.slice(1))
      .enter()
      .append('circle')
      .attr('class', 'link-end-dot')
      .attr('cx', d => d.x)
      .attr('cy', d => d.y)
      .attr('r', 10) // Increased inner dot radius
      .style('fill', '#fff'); // White dot color

    // Tooltip
    const tooltip = d3.select('body').append('div')
      .attr('class', 'tooltip')
      .style('opacity', 0);

    links.on('mouseover', function (event, d) {
      tooltip.transition()
        .duration(200)
        .style('opacity', .9);
      tooltip.html(d.text)
        .style('left', (event.pageX) + 'px')
        .style('top', (event.pageY - 28) + 'px');
    })
    .on('mouseout', function (d) {
      tooltip.transition()
        .duration(500)
        .style('opacity', 0);
    });
  });
</script>
{% endblock %}
